<!DOCTYPE html>
<html>
  <head>
    <title>DSN + EgaPro demo</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container">
      <h1 class="display-1 text-center">Démo DSN + EgaPro</h1>
      <div class="mb-3">
        <textarea
          class="form-control"
          id="textarea"
          rows="30"
          style="font-size: 10px"
        >
{
  "index . écart rémunérations . ouvriers . moins de 30 ans . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . ouvriers . moins de 30 ans . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . ouvriers . moins de 30 ans . nombre salariés . hommes": 0,
  "index . écart rémunérations . ouvriers . moins de 30 ans . nombre salariés . femmes": 0,
  "index . écart rémunérations . ouvriers . de 30 à 39 ans . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . ouvriers . de 30 à 39 ans . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . ouvriers . de 30 à 39 ans . nombre salariés . hommes": 0,
  "index . écart rémunérations . ouvriers . de 30 à 39 ans . nombre salariés . femmes": 0,
  "index . écart rémunérations . ouvriers . de 40 à 49 ans . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . ouvriers . de 40 à 49 ans . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . ouvriers . de 40 à 49 ans . nombre salariés . hommes": 0,
  "index . écart rémunérations . ouvriers . de 40 à 49 ans . nombre salariés . femmes": 0,
  "index . écart rémunérations . ouvriers . de 50 ans et plus . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . ouvriers . de 50 ans et plus . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . ouvriers . de 50 ans et plus . nombre salariés . hommes": 0,
  "index . écart rémunérations . ouvriers . de 50 ans et plus . nombre salariés . femmes": 0,
  "index . écart rémunérations . employés . moins de 30 ans . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . employés . moins de 30 ans . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . employés . moins de 30 ans . nombre salariés . hommes": 0,
  "index . écart rémunérations . employés . moins de 30 ans . nombre salariés . femmes": 0,
  "index . écart rémunérations . employés . de 30 à 39 ans . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . employés . de 30 à 39 ans . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . employés . de 30 à 39 ans . nombre salariés . hommes": 0,
  "index . écart rémunérations . employés . de 30 à 39 ans . nombre salariés . femmes": 0,
  "index . écart rémunérations . employés . de 40 à 49 ans . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . employés . de 40 à 49 ans . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . employés . de 40 à 49 ans . nombre salariés . hommes": 0,
  "index . écart rémunérations . employés . de 40 à 49 ans . nombre salariés . femmes": 0,
  "index . écart rémunérations . employés . de 50 ans et plus . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . employés . de 50 ans et plus . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . employés . de 50 ans et plus . nombre salariés . hommes": 0,
  "index . écart rémunérations . employés . de 50 ans et plus . nombre salariés . femmes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . moins de 30 ans . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . moins de 30 ans . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . moins de 30 ans . nombre salariés . hommes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . moins de 30 ans . nombre salariés . femmes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . de 30 à 39 ans . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . de 30 à 39 ans . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . de 30 à 39 ans . nombre salariés . hommes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . de 30 à 39 ans . nombre salariés . femmes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . de 40 à 49 ans . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . de 40 à 49 ans . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . de 40 à 49 ans . nombre salariés . hommes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . de 40 à 49 ans . nombre salariés . femmes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . de 50 ans et plus . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . de 50 ans et plus . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . de 50 ans et plus . nombre salariés . hommes": 0,
  "index . écart rémunérations . techniciens et agents de maîtrise . de 50 ans et plus . nombre salariés . femmes": 0,
  "index . écart rémunérations . ingénieurs et cadres . moins de 30 ans . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . ingénieurs et cadres . moins de 30 ans . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . ingénieurs et cadres . moins de 30 ans . nombre salariés . hommes": 0,
  "index . écart rémunérations . ingénieurs et cadres . moins de 30 ans . nombre salariés . femmes": 0,
  "index . écart rémunérations . ingénieurs et cadres . de 30 à 39 ans . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . ingénieurs et cadres . de 30 à 39 ans . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . ingénieurs et cadres . de 30 à 39 ans . nombre salariés . hommes": 0,
  "index . écart rémunérations . ingénieurs et cadres . de 30 à 39 ans . nombre salariés . femmes": 0,
  "index . écart rémunérations . ingénieurs et cadres . de 40 à 49 ans . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . ingénieurs et cadres . de 40 à 49 ans . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . ingénieurs et cadres . de 40 à 49 ans . nombre salariés . hommes": 0,
  "index . écart rémunérations . ingénieurs et cadres . de 40 à 49 ans . nombre salariés . femmes": 0,
  "index . écart rémunérations . ingénieurs et cadres . de 50 ans et plus . remunération annuelle brute moyenne par EQTP . hommes": 0,
  "index . écart rémunérations . ingénieurs et cadres . de 50 ans et plus . remunération annuelle brute moyenne par EQTP . femmes": 0,
  "index . écart rémunérations . ingénieurs et cadres . de 50 ans et plus . nombre salariés . hommes": 0,
  "index . écart rémunérations . ingénieurs et cadres . de 50 ans et plus . nombre salariés . femmes": 0,

  "index . écart augmentations . ouvriers . hommes": 0,
  "index . écart augmentations . ouvriers . femmes": 0,
  "index . écart augmentations . employés . hommes": 0,
  "index . écart augmentations . employés . femmes": 0,
  "index . écart augmentations . techniciens et agents de maîtrise . hommes": 0,
  "index . écart augmentations . techniciens et agents de maîtrise . femmes": 0,
  "index . écart augmentations . ingénieurs et cadres . hommes": 0,
  "index . écart augmentations . ingénieurs et cadres . femmes": 0,

  "index . écart promotions . ouvriers . hommes": 0,
  "index . écart promotions . ouvriers . femmes": 0,
  "index . écart promotions . employés . hommes": 0,
  "index . écart promotions . employés . femmes": 0,
  "index . écart promotions . techniciens et agents de maîtrise . hommes": 0,
  "index . écart promotions . techniciens et agents de maîtrise . femmes": 0,
  "index . écart promotions . ingénieurs et cadres . hommes": 0,
  "index . écart promotions . ingénieurs et cadres . femmes": 0,

  "index . maternité . nombre total": 0,
  "index . maternité . nombre augmentés": 0,

  "index . hautes rémunérations . femmes": 0,
  "index . hautes rémunérations . hommes": 0
}
</textarea
        >
        <div class="gap-2">
          <button id="cas1" type="button" class="btn btn-light">Cas 1</button>
          <button id="cas2" type="button" class="btn btn-light">Cas 2</button>
          <button id="cas3" type="button" class="btn btn-light">Cas 3</button>
        </div>
        <div class="d-grid gap-2">
          <button id="submit" type="button" class="btn btn-primary">
            Calculer
          </button>
        </div>
        <div class="mb-3" id="result"></div>
        <div class="d-grid gap-2">
          <button id="debug" type="button" class="btn btn-secondary">
            debug
          </button>
        </div>
      </div>
    </div>
    <script type="module">
      import yaml from "https://cdn.jsdelivr.net/npm/yaml@2.4.2/+esm";

      const textarea = document.getElementById("textarea");
      const result = document.getElementById("result");
      const publicodesUrl = `/evaluate`;

      const callPublicodes = (situation) =>
        fetch(publicodesUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            expressions: "json",
            situation,
          }),
        }).then((r) => r.json());

      const showResult = (params) => {
        const keys = Object.keys(params).filter((k) => k !== "note");
        return `
                 <h3 class="display-3 text-center">Note: ${params.note}</h3>
                 <table class="table">
                   ${keys
                     .map(
                       (key) =>
                         `<tr class="table-light"><th colspan="2">${key}</th></tr>${Object.keys(
                           params[key]
                         )
                           .map(
                             (key2) =>
                               `<tr><td>${key2}</td><td>${params[key][key2]}</td></tr>`
                           )
                           .join("\n")}`
                     )
                     .join("\n")}
                   </table>
                 `;
      };

      const onSubmit = async () => {
        const situation = JSON.parse(textarea.value);
        console.log("situation", situation);
        const res = await callPublicodes(situation);
        console.log("res", res);
        const value =
          res.evaluate && res.evaluate.length && res.evaluate[0].nodeValue;
        if (value) {
          result.innerHTML = showResult(JSON.parse(value));
        }
      };

      document.getElementById("submit").addEventListener("click", onSubmit);

      document.getElementById("debug").addEventListener("click", async () => {
        const situation = JSON.parse(textarea.value);
        const rules = await fetch("./publicodes.yaml").then((r) => r.text());

        const jsonRules = {
          ...yaml.parse(rules),
          ...situation,
        };
        const yamlRules = yaml.stringify(jsonRules);

        const url = `https://publi.codes/studio/index/note#${encodeURIComponent(
          yamlRules
        )}`;
        console.log({
          situation,
          jsonRules,
          yamlRules,
          url,
        });
        window.open(url);
      });
    </script>
  </body>
</html>
